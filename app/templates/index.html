<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Weather App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
    <h1>Weather App</h1>
    
    <!-- Input Form -->
    <form action="/weather" method="post" autocomplete="off">
        <label for="location">Enter Location:</label>
        <input type="text" id="location" name="location" placeholder="Start typing and select a location from suggestions" required>
        <div id="location_suggestions" class="autocomplete-suggestions" style="display:none;"></div>

        <!-- new div for inline error -->
        <div id="location-error" style="color:red; font-size:0.9em; margin-bottom:10px;"></div>
        <small style="display:block; color:#555; margin-bottom:10px;">
             Please select a location from the dropdown suggestions.
        </small>
        <label for="start_date">Start Date:</label>
        <input type="date" id="start_date" name="start_date" required>

        <label for="end_date">End Date:</label>
        <input type="date" id="end_date" name="end_date" required>

        <button type="submit">Get Weather</button>
    </form>

    <!-- Display Errors -->
    {% if error %}
    <div class="results">
        <p style="color:red;">{{ error }}</p>
    </div>
    {% endif %}

    <!-- Display Weather Results -->
    {% if weather_data %}
    <div class="results">
        <h2>Weather Results for {{ weather_data[0].location }}</h2>
        {% for entry in weather_data %}
        <div class="weather-entry">
            <strong>Date:</strong> {{ entry.date }}<br>
            <strong>Temperature:</strong> {{ entry.temperature }}°C<br>
            <strong>Description:</strong> {{ entry.description }}<br>
            <strong>Humidity:</strong> {{ entry.humidity }}%<br>
            <strong>Wind Speed:</strong> {{ entry.wind_speed }} kph
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {% if youtube_videos %}
    <div class="youtube-box">
        <h3>YouTube Videos for {{ location }}</h3>
        <div class="youtube-grid">
            {% for video in youtube_videos %}
            <div class="youtube-card">
                <a href="{{ video.video_url }}" target="_blank">
                    <img src="{{ video.thumbnail }}" alt="{{ video.title }}" style="width:100%">
                    <p>{{ video.title }}</p>
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}


    <div class="results">
        <h2>All Weather Records</h2>
        <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 15px;">
            <button id="view-all-btn">View All Weather Records</button>
            <a href="/export/csv" target="_blank">
                <button type="button" class="small-button" style="background:#28a745;">
                    Download Weather Data
                </button>
            </a>
        </div>
        <table id="weather-table" border="1" cellpadding="8" cellspacing="0" 
            style="width:100%; border-collapse: collapse; display:none;">
            <thead>
                <tr>
                    <th>Location</th>
                    <th>Date</th>
                    <th>Temperature (°C)</th>
                    <th>Description</th>
                    <th>Humidity (%)</th>
                    <th>Wind Speed (kph)</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    {% if success_delete %}
    <div id="delete-message" style="margin-top:10px; color:green; text-align:center;">
        {{ success_delete }}
    </div>
    {% endif %}

    <h2 class="center-heading">Update Weather Record</h2>
    <p style="text-align:center; color:#555; margin-bottom:15px;">
        Fill the form below to update an existing weather record for a location on a specific date. 
        Leave any field blank to keep its current value unchanged.
    </p>
    <form action="/weather/update" method="post" autocomplete="off">
        <label for="update_location">Location:</label>
        <input type="text" id="update_location" name="location" placeholder="Select location" required class="required-field">
        <div id="update_location_suggestions" class="autocomplete-suggestions" style="display:none;"></div>

        <label for="update_date">Date:</label>
        <input type="date" id="update_date" name="date" required class="required-field">

        <label for="update_temperature">Temperature (°C):</label>
        <input type="number" step="0.1" id="update_temperature" name="temperature" placeholder="Leave blank to keep current value">

        <label for="update_description">Description:</label>
        <input type="text" id="update_description" name="description" placeholder="Leave blank to keep current value">

        <label for="update_humidity">Humidity (%):</label>
        <input type="number" id="update_humidity" name="humidity" placeholder="Leave blank to keep current value">

        <label for="update_wind_speed">Wind Speed (kph):</label>
        <input type="number" step="0.1" id="update_wind_speed" name="wind_speed" placeholder="Leave blank to keep current value">

        <button type="submit">Update Weather</button>
    </form>

    {% if error_update %}
    <div class="results">
        <p style="color:red;">{{ error_update }}</p>
    </div>
    {% endif %}

    {% if success_update %}
    <div class="results">
        <p style="color:green;">{{ success_update }}</p>
    </div>
    {% endif %}

     <!-- Display Updated Weather Results -->
    {% if updated_weather %}
    <div class="results">
        <h2>Updated Weather Record</h2>
        {% for entry in updated_weather %}
        <div class="weather-entry">
            <strong>Date:</strong> {{ entry.date }}<br>
            <strong>Temperature:</strong> {{ entry.temperature }}°C<br>
            <strong>Description:</strong> {{ entry.description }}<br>
            <strong>Humidity:</strong> {{ entry.humidity }}%<br>
            <strong>Wind Speed:</strong> {{ entry.wind_speed }} kph
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <script>
        const locationInput = document.getElementById("location");
        const suggestionsBox = document.getElementById("location_suggestions");
        let validLocations = []; // store current suggestions

        locationInput.addEventListener("input", async () => {
            const query = locationInput.value;
            if (query.length < 2) {
                suggestionsBox.style.display = "none";
                validLocations = [];
                return;
            }

            try {
                const res = await fetch(`/search_location?q=${query}`);
                const data = await res.json();

                suggestionsBox.innerHTML = "";
                validLocations = [];

                if (data.locations && data.locations.length > 0) {
                    data.locations.forEach(loc => {
                        const div = document.createElement("div");
                        div.textContent = loc;
                        div.classList.add("autocomplete-suggestion");
                        div.addEventListener("click", () => {
                            locationInput.value = loc;
                            suggestionsBox.style.display = "none";
                            validLocations = [loc]; // only the selected one is valid now
                        });
                        suggestionsBox.appendChild(div);
                        validLocations.push(loc);
                    });
                    suggestionsBox.style.display = "block";
                } else {
                    suggestionsBox.style.display = "none";
                }
            } catch (err) {
                console.error("Error fetching location suggestions:", err);
                suggestionsBox.style.display = "none";
                validLocations = [];
            }
        });

        // Hide suggestions if user clicks outside
        document.addEventListener("click", (e) => {
            if (!locationInput.contains(e.target) && !suggestionsBox.contains(e.target)) {
                suggestionsBox.style.display = "none";
            }
        });

        // Force form submission only if input matches a valid location
        const form = document.querySelector("form");
        form.addEventListener("submit", (e) => {
            const errorBox = document.getElementById("location-error");
            if (!validLocations.includes(locationInput.value)) {
                e.preventDefault();
                errorBox.textContent = "⚠️ Please select a valid location from the suggestions.";
                locationInput.focus();
            } else {
                errorBox.textContent = "";
            }
        });

        // Set min/max for date inputs dynamically
        const today = new Date();
        const maxDate = new Date();
        maxDate.setDate(today.getDate() + 4); // 5-day forecast

        const formatDate = (date) => date.toISOString().split('T')[0];

        document.getElementById('start_date').setAttribute('min', formatDate(today));
        document.getElementById('start_date').setAttribute('max', formatDate(maxDate));

        document.getElementById('end_date').setAttribute('min', formatDate(today));
        document.getElementById('end_date').setAttribute('max', formatDate(maxDate));

        document.getElementById("view-all-btn").addEventListener("click", async () => {
        try {
            const res = await fetch("/weather"); // GET request
            const data = await res.json();

            const table = document.getElementById("weather-table");
            const tbody = table.querySelector("tbody");
            tbody.innerHTML = ""; // clear previous rows

            data.forEach(item => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${item.location}</td>
                    <td>${item.date}</td>
                    <td>${item.temperature ?? "-"}</td>
                    <td>${item.description ?? "-"}</td>
                    <td>${item.humidity ?? "-"}</td>
                    <td>${item.wind_speed ?? "-"}</td>
                    <td>
                    <!-- Delete form with confirmation -->
                    <form action="/delete/${item.id}" method="post" onsubmit="return confirm('Are you sure you want to delete this record?');">
                        <button type="submit" class="action-button" style="background:#dc3545; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">
                            Delete
                        </button>
                    </form>
                    </td>
            `   ;
                tbody.appendChild(row);
            });

            table.style.display = "table"; // show table

        } catch (err) {
            alert("Error fetching weather data: " + err);
        }
    });
    </script>

    <script>
        const updateLocationInput = document.getElementById("update_location");
        const updateSuggestionsBox = document.getElementById("update_location_suggestions");
        let validUpdateLocations = [];

        updateLocationInput.addEventListener("input", async () => {
            const query = updateLocationInput.value;
            if (query.length < 2) {
                updateSuggestionsBox.style.display = "none";
                validUpdateLocations = [];
                return;
            }

            try {
                const res = await fetch(`/search_location?q=${query}`);
                const data = await res.json();

                updateSuggestionsBox.innerHTML = "";
                validUpdateLocations = [];

                if (data.locations && data.locations.length > 0) {
                    data.locations.forEach(loc => {
                        const div = document.createElement("div");
                        div.textContent = loc;
                        div.classList.add("autocomplete-suggestion");
                        div.addEventListener("click", () => {
                            updateLocationInput.value = loc;
                            updateSuggestionsBox.style.display = "none";
                            validUpdateLocations = [loc];
                        });
                        updateSuggestionsBox.appendChild(div);
                        validUpdateLocations.push(loc);
                    });
                    updateSuggestionsBox.style.display = "block";
                } else {
                    updateSuggestionsBox.style.display = "none";
                }
            } catch (err) {
                console.error("Error fetching location suggestions:", err);
                updateSuggestionsBox.style.display = "none";
                validUpdateLocations = [];
            }
        });

        // Hide suggestions if user clicks outside
        document.addEventListener("click", (e) => {
            if (!updateLocationInput.contains(e.target) && !updateSuggestionsBox.contains(e.target)) {
                updateSuggestionsBox.style.display = "none";
            }
        });

        // Force form submission only if location is valid
        const updateForm = document.querySelector("form[action='/weather/update']");
        updateForm.addEventListener("submit", (e) => {
            if (!validUpdateLocations.includes(updateLocationInput.value)) {
                e.preventDefault();
                alert("⚠️ Please select a valid location from the suggestions.");
                updateLocationInput.focus();
            }
        });

        // Set min/max for update date input
        const updateToday = new Date();
        const updateMaxDate = new Date();
        updateMaxDate.setDate(updateToday.getDate() + 4);

        const formatUpdateDate = (date) => date.toISOString().split('T')[0];

        document.getElementById('update_date').setAttribute('min');
        document.getElementById('update_date').setAttribute('max');
</script>
<script>
    const msg = document.getElementById("delete-message");
    if (msg) {
        setTimeout(() => {
            msg.style.display = "none";  // hides after 5 seconds
        }, 5000);
    }
</script>

<!-- Thin Footer Strip -->
<footer class="footer">
    <strong>Developed by Ramandeep Kaur</strong> | 
    <strong>PM Accelerator</strong>: <a href="https://www.pmaccelerator.io/" target="_blank" style="color:#007BFF; text-decoration:underline;">Website</a>
    <p>
        <strong>PM Accelerator:</strong> The Product Manager Accelerator Program is designed to support PM professionals through every stage of their careers. From students looking for entry-level jobs to Directors seeking leadership roles, our program has helped hundreds of students achieve their career aspirations.
        Our Product Manager Accelerator community is ambitious and committed. Through our program, participants have learned, honed, and developed new PM and leadership skills, giving them a strong foundation for future endeavors.
        Learn more on our Website.
    </p>
</footer>


</body>
</html>